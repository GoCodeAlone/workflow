modules:
  - name: messaging-server
    type: httpserver.modular
    config:
      address: ":8085"
  - name: messaging-router
    type: chimux.router
  - name: messaging-auth
    type: auth.modular
    config:
      enableJWT: true
      enableApiKey: false
  - name: messaging-cache
    type: cache.modular
    config:
      engine: "memory"
      defaultTTL: 3600
      cleanupInterval: 600
      maxItems: 10000
  - name: messaging-database
    type: database.modular
    config:
      driver: sqlite
      dsn: ":memory:"
  - name: messaging-eventbus
    type: eventbus.modular
  - name: messaging-logger
    type: eventlogger.modular
  - name: messaging-client
    type: httpclient.modular
  - name: message-scheduler
    type: scheduler.modular
    config:
      timezone: "UTC"
  - name: websocket-handler
    type: api.handler
    config:
      resourceName: "messages"
  - name: user-handler
    type: api.handler
    config:
      resourceName: "users"
  - name: message-processor
    type: messaging.handler
  - name: presence-updater
    type: messaging.handler
  - name: notification-sender
    type: messaging.handler

workflows:
  http:
    routes:
      - method: POST
        path: /api/users/connect
        handler: user-handler
      - method: GET
        path: /api/messages/history
        handler: websocket-handler
      - method: POST
        path: /api/messages/send
        handler: websocket-handler
  messaging:
    subscriptions:
      - topic: message.sent
        handler: message-processor
      - topic: user.connected
        handler: presence-updater
      - topic: user.disconnected
        handler: presence-updater
      - topic: message.processed
        handler: notification-sender
    producers:
      - name: websocket-handler
        forwardTo: [message.sent]
      - name: user-handler
        forwardTo: [user.connected, user.disconnected]
      - name: message-processor
        forwardTo: [message.processed]
  scheduler:
    jobs:
      - scheduler: message-scheduler
        job: presence-cleanup
        schedule: "*/5 * * * *"

# Configuration sections for modular modules
auth:
  JWT:
    Secret: "test-jwt-secret-key-for-messaging"
    Expiration: "24h"
  
cache:
  defaultTTL: 3600  # 1 hour in seconds
  cleanupInterval: 600  # 10 minutes in seconds
  maxItems: 10000

database:
  driver: sqlite
  dsn: ":memory:"

scheduler:
  timezone: "UTC"
  maxConcurrentJobs: 10

httpserver:
  address: ":8085"
  enableGracefulShutdown: true