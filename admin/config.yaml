# Built-in Workflow Admin UI Configuration
#
# This config is embedded into the binary and enabled with the --admin flag.
# It dogfoods the workflow engine to serve its own admin UI: the engine's
# modules (HTTP server, router, auth, static file server, management API)
# provide an authenticated admin interface running on the same engine as the
# primary workflow.
#
# Usage:
#   JWT_SECRET=your-secret go run ./cmd/server \
#     -config your-workflow.yaml --admin
#
# On first launch, visit the admin UI to create your admin account.

modules:
  # --- HTTP Server (admin port) ---
  - name: admin-server
    type: http.server
    config:
      address: ":8081"

  - name: admin-router
    type: http.router
    dependsOn: [admin-server]

  # --- Middleware ---
  - name: admin-cors
    type: http.middleware.cors
    config:
      allowedOrigins: ["*"]
      allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

  - name: admin-ratelimit
    type: http.middleware.ratelimit
    config:
      requestsPerMinute: 120
      burstSize: 20

  # --- Data Layer ---
  - name: admin-db
    type: storage.sqlite
    config:
      dbPath: "data/workflow.db"

  - name: admin-workflow-registry
    type: workflow.registry
    config:
      storageBackend: "admin-db"
    dependsOn: [admin-db]

  - name: admin-user-store
    type: auth.user-store
    dependsOn: [admin-db]

  # --- Auth ---
  - name: admin-auth
    type: auth.jwt
    config:
      secret: "${JWT_SECRET}"
      tokenExpiry: "24h"
      issuer: "workflow-admin"
      responseFormat: "v1"
    dependsOn: [admin-user-store]

  - name: admin-auth-middleware
    type: http.middleware.auth
    config:
      authType: Bearer
    dependsOn: [admin-auth]

  # --- Engine Management (CQRS) ---
  - name: admin-engine-queries
    type: api.query
    config:
      delegate: admin-engine-mgmt
    dependsOn: [admin-router]

  - name: admin-engine-commands
    type: api.command
    config:
      delegate: admin-engine-mgmt
    dependsOn: [admin-router]

  # --- Schema API (read-only) ---
  - name: admin-schema-queries
    type: api.query
    config:
      delegate: admin-schema-mgmt
    dependsOn: [admin-router]

  # --- AI API (CQRS) ---
  - name: admin-ai-queries
    type: api.query
    config:
      delegate: admin-ai-mgmt
    dependsOn: [admin-router]

  - name: admin-ai-commands
    type: api.command
    config:
      delegate: admin-ai-mgmt
    dependsOn: [admin-router]

  # --- Dynamic Components API (CQRS) ---
  - name: admin-component-queries
    type: api.query
    config:
      delegate: admin-component-mgmt
    dependsOn: [admin-router]

  - name: admin-component-commands
    type: api.command
    config:
      delegate: admin-component-mgmt
    dependsOn: [admin-router]

  # --- v1 API (CQRS) ---
  - name: admin-v1-queries
    type: api.query
    config:
      delegate: admin-v1-mgmt
    dependsOn: [admin-workflow-registry, admin-auth]

  - name: admin-v1-commands
    type: api.command
    config:
      delegate: admin-v1-mgmt
    dependsOn: [admin-workflow-registry, admin-auth]

  # --- Static File Server (serves embedded React UI) ---
  # The root path is injected at runtime from extracted embed.FS assets.
  # The router field ensures this file server attaches to admin-router, not
  # the primary workflow's router.
  - name: admin-ui
    type: static.fileserver
    config:
      root: "../module/ui_dist"
      prefix: "/"
      spaFallback: true
      cacheMaxAge: 3600
      router: admin-router
    dependsOn: [admin-router]

  # --- OpenAPI ---
  - name: admin-openapi
    type: openapi.generator
    config:
      title: "Workflow Admin API"
      version: "1.0.0"
      description: "Auto-generated OpenAPI spec from the workflow admin routes"
    dependsOn: [admin-router]

  # --- Observability ---
  - name: admin-health
    type: health.checker

  - name: admin-metrics
    type: metrics.collector

workflows:
  http-admin:
    router: admin-router
    server: admin-server
    routes:
      # === Setup (unauthenticated) ===
      - method: GET
        path: "/api/v1/auth/setup-status"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]
      - method: POST
        path: "/api/v1/auth/setup"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]

      # === Auth (unauthenticated) ===
      - method: POST
        path: "/api/v1/auth/login"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]
      - method: POST
        path: "/api/v1/auth/register"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]
      - method: POST
        path: "/api/v1/auth/refresh"
        handler: admin-auth
        middlewares: [admin-cors]

      # === Auth (authenticated) ===
      - method: POST
        path: "/api/v1/auth/logout"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/auth/me"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/auth/me"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]

      # === User Management (authenticated, admin-only) ===
      - method: GET
        path: "/api/v1/auth/users"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/auth/users"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/auth/users/{id}"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/auth/users/{id}/role"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]

      # === Engine Management Queries (authenticated) ===
      - method: GET
        path: "/api/v1/admin/engine/config"
        handler: admin-engine-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/engine/status"
        handler: admin-engine-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/engine/modules"
        handler: admin-engine-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === Engine Management Commands (authenticated) ===
      - method: PUT
        path: "/api/v1/admin/engine/config"
        handler: admin-engine-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/engine/validate"
        handler: admin-engine-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/engine/reload"
        handler: admin-engine-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === Schema Queries (authenticated) ===
      - method: GET
        path: "/api/v1/admin/schemas"
        handler: admin-schema-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/schemas/modules"
        handler: admin-schema-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === AI Queries (authenticated) ===
      - method: GET
        path: "/api/v1/admin/ai/providers"
        handler: admin-ai-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === AI Commands (authenticated) ===
      - method: POST
        path: "/api/v1/admin/ai/generate"
        handler: admin-ai-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/ai/component"
        handler: admin-ai-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/ai/suggest"
        handler: admin-ai-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/ai/deploy"
        handler: admin-ai-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/ai/deploy/component"
        handler: admin-ai-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === Component Queries (authenticated) ===
      - method: GET
        path: "/api/v1/admin/components"
        handler: admin-component-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/components/{id}"
        handler: admin-component-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === Component Commands (authenticated) ===
      - method: POST
        path: "/api/v1/admin/components"
        handler: admin-component-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/admin/components/{id}"
        handler: admin-component-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/admin/components/{id}"
        handler: admin-component-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Dashboard (authenticated) ===
      - method: GET
        path: "/api/v1/admin/dashboard"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Companies (authenticated) ===
      - method: GET
        path: "/api/v1/admin/companies"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/companies"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/companies/{id}"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/companies/{id}/organizations"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Organizations (authenticated) ===
      - method: POST
        path: "/api/v1/admin/companies/{id}/organizations"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/organizations/{id}/projects"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/organizations/{id}/projects"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Projects (authenticated) ===
      - method: GET
        path: "/api/v1/admin/projects/{id}/workflows"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/projects/{id}/workflows"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Workflows (authenticated) ===
      - method: GET
        path: "/api/v1/admin/workflows"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/workflows"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/versions"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/workflows/{id}/deploy"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/workflows/{id}/stop"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/status"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/dashboard"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/executions"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/workflows/{id}/trigger"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/logs"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/logs/stream"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/events"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/events/stream"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/workflows/{id}/permissions"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/workflows/{id}/permissions"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Executions (authenticated) ===
      - method: GET
        path: "/api/v1/admin/executions/{id}"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/executions/{id}/steps"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/executions/{id}/cancel"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: Audit (authenticated) ===
      - method: GET
        path: "/api/v1/admin/audit"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]

      # === v1 API: IAM (authenticated) ===
      - method: GET
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/iam/providers"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/iam/providers/{id}/test"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/admin/iam/providers/{id}/mappings"
        handler: admin-v1-queries
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/admin/iam/providers/{id}/mappings"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/admin/iam/mappings/{id}"
        handler: admin-v1-commands
        middlewares: [admin-cors, admin-auth-middleware]

      # === OpenAPI Spec (unauthenticated, read-only) ===
      - method: GET
        path: "/api/openapi.json"
        handler: admin-openapi
        middlewares: [admin-cors]
      - method: GET
        path: "/api/openapi.yaml"
        handler: admin-openapi
        middlewares: [admin-cors]
