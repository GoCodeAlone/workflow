import { useState, useEffect } from 'react'

interface Item {
  id: string
  name: string
  createdAt: string
}

const styles = {
  container: { maxWidth: 800, margin: '40px auto', padding: '0 20px' } as React.CSSProperties,
  heading: { marginBottom: 24, color: '#1a1a1a' } as React.CSSProperties,
  error: { background: '#fee', border: '1px solid #fcc', borderRadius: 4, padding: '12px 16px', marginBottom: 16, color: '#c00', display: 'flex', justifyContent: 'space-between' } as React.CSSProperties,
  errorBtn: { background: 'none', border: 'none', cursor: 'pointer', color: '#c00' } as React.CSSProperties,
  row: { display: 'flex', gap: 8, marginBottom: 24 } as React.CSSProperties,
  input: { flex: 1, padding: '8px 12px', border: '1px solid #ddd', borderRadius: 4, fontSize: 14 } as React.CSSProperties,
  addBtn: { padding: '8px 16px', background: '#0070f3', color: '#fff', border: 'none', borderRadius: 4, cursor: 'pointer', fontSize: 14 } as React.CSSProperties,
  list: { listStyle: 'none', display: 'flex', flexDirection: 'column', gap: 8 } as React.CSSProperties,
  listItem: { background: '#fff', border: '1px solid #e5e5e5', borderRadius: 6, padding: '12px 16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } as React.CSSProperties,
  itemName: { fontWeight: 500 } as React.CSSProperties,
  itemDate: { marginLeft: 12, fontSize: 12, color: '#999' } as React.CSSProperties,
  deleteBtn: { background: 'none', border: '1px solid #ddd', borderRadius: 4, cursor: 'pointer', padding: '4px 8px', color: '#666', fontSize: 12 } as React.CSSProperties,
  muted: { color: '#666' } as React.CSSProperties,
}

function App() {
  const [items, setItems] = useState<Item[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [newItemName, setNewItemName] = useState('')

  const fetchItems = async () => {
    try {
      setLoading(true)
      const res = await fetch('/api/items')
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      const data = await res.json()
      setItems(Array.isArray(data) ? data : [])
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch items')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchItems()
  }, [])

  const createItem = async () => {
    if (!newItemName.trim()) return
    try {
      const res = await fetch('/api/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newItemName }),
      })
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      setNewItemName('')
      await fetchItems()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to create item')
    }
  }

  const deleteItem = async (id: string) => {
    try {
      const res = await fetch(`/api/items/${id}`, { method: 'DELETE' })
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      await fetchItems()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to delete item')
    }
  }

  return (
    <div style={styles.container}>
      <h1 style={styles.heading}>{{.Name}}</h1>

      {error && (
        <div style={styles.error}>
          <span>{error}</span>
          <button onClick={() => setError(null)} style={styles.errorBtn}>x</button>
        </div>
      )}

      <div style={styles.row}>
        <input
          type="text"
          value={newItemName}
          onChange={e => setNewItemName(e.target.value)}
          onKeyDown={e => e.key === 'Enter' && createItem()}
          placeholder="New item name..."
          style={styles.input}
        />
        <button onClick={createItem} style={styles.addBtn}>Add</button>
      </div>

      {loading ? (
        <p style={styles.muted}>Loading...</p>
      ) : items.length === 0 ? (
        <p style={styles.muted}>No items yet. Create one above.</p>
      ) : (
        <ul style={styles.list}>
          {items.map(item => (
            <li key={item.id} style={styles.listItem}>
              <div>
                <span style={styles.itemName}>{item.name}</span>
                {item.createdAt && (
                  <span style={styles.itemDate}>
                    {new Date(item.createdAt).toLocaleDateString()}
                  </span>
                )}
              </div>
              <button onClick={() => deleteItem(item.id)} style={styles.deleteBtn}>Delete</button>
            </li>
          ))}
        </ul>
      )}
    </div>
  )
}

export default App
