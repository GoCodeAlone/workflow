# Gateway Container Configuration
# Serves the SPA and proxies API requests to backend services.
#
# Architecture:
#   Browser -> [gateway:8080] -> SPA (static files)
#                             -> /api/auth/*          -> api:8081
#                             -> /api/affiliates/*    -> api:8081
#                             -> /api/programs/*      -> api:8081
#                             -> /api/users/*         -> api:8081
#                             -> /api/keywords/*      -> api:8081
#                             -> /api/surveys/*       -> api:8081
#                             -> /api/admin/*         -> api:8081
#                             -> /api/conversations/* -> conversation:8082
#                             -> /api/messages/*      -> conversation:8082
#                             -> /api/queue/*         -> conversation:8082
#                             -> /api/webhooks/*      -> conversation:8082
#                             -> /api/webchat/*       -> conversation:8082
#                             -> /api/providers/*     -> conversation:8082
#
# No business logic -- pure routing and static file serving.

requires:
  plugins:
    - name: observability
    - name: workflow-plugin-http

modules:
  # --- HTTP infrastructure ---
  - name: web-server
    type: http.server
    config:
      address: ":8080"
      readTimeout: "15s"
      writeTimeout: "15s"

  - name: router
    type: http.router
    config:
      prefix: /api
    dependsOn:
      - web-server

  # --- Reverse proxy to backend services ---
  - name: api-proxy
    type: http.simple_proxy
    config:
      targets:
        "/api/auth": "http://api:8081"
        "/api/affiliates": "http://api:8081"
        "/api/programs": "http://api:8081"
        "/api/users": "http://api:8081"
        "/api/keywords": "http://api:8081"
        "/api/surveys": "http://api:8081"
        "/api/admin": "http://api:8081"
        "/api/conversations": "http://conversation:8082"
        "/api/messages": "http://conversation:8082"
        "/api/queue": "http://conversation:8082"
        "/api/webhooks": "http://conversation:8082"
        "/api/webchat": "http://conversation:8082"
        "/api/providers": "http://conversation:8082"
    dependsOn:
      - router

  # --- Middleware chain ---
  - name: cors
    type: http.middleware.cors
    config:
      allowedOrigins: ["http://localhost:8080", "https://localhost:8080"]
      allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      allowedHeaders: ["Content-Type", "Authorization"]
      maxAge: 3600
    dependsOn:
      - router

  - name: request-id
    type: http.middleware.requestid
    dependsOn:
      - cors

  - name: security-headers
    type: http.middleware.securityheaders
    config:
      contentSecurityPolicy: "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'"
      frameOptions: "DENY"
      contentTypeOptions: "nosniff"
      referrerPolicy: "strict-origin-when-cross-origin"
      permissionsPolicy: "camera=(), microphone=(), geolocation=()"
    dependsOn:
      - request-id

  # --- Observability ---
  - name: metrics
    type: metrics.collector
    config:
      namespace: chat_gateway

  - name: health
    type: health.checker
    config:
      description: "Gateway health, readiness, and liveness probes"

  # --- Static file serving (SPA) ---
  - name: spa
    type: static.fileserver
    config:
      root: "../spa"
      prefix: "/spa/"
      spaFallback: true
      cacheMaxAge: 3600
    dependsOn:
      - web-server

# --- Workflow definitions ---
workflows:
  http:
    router: router
    server: web-server
    routes:
      # --- Platform API routes (proxied to api:8081) ---
      - method: "POST"
        path: "/api/auth/login"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/auth/register"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/auth/profile"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "PUT"
        path: "/api/auth/profile"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/affiliates"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/affiliates/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/affiliates"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/programs"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/programs/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/programs"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/users"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/users/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/users"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/keywords"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/keywords/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/keywords"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/surveys"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/surveys/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/surveys"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/admin/{path}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      # --- Conversation routes (proxied to conversation:8082) ---
      - method: "GET"
        path: "/api/conversations"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/conversations/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/messages"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/assign"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/transfer"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/escalate"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/wrap-up"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/close"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/follow-up"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/tag"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/conversations/{id}/survey"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/conversations/{id}/summary"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/queue"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/queue/health"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/providers"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      # --- Webhook routes (proxied to conversation:8082, public) ---
      - method: "POST"
        path: "/api/webhooks/twilio"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/webhooks/aws"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/webhooks/partner"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "POST"
        path: "/api/webchat/message"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers

      - method: "GET"
        path: "/api/webchat/poll/{id}"
        handler: api-proxy
        middlewares:
          - cors
          - request-id
          - security-headers
