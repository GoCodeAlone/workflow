# Multi-container e-commerce application with Kafka communication.
#
# Architecture:
#   gateway        - SPA + reverse proxy (port 8080)
#   users-products - Auth + product catalog
#   orders         - Order state machine + Kafka messaging
#   kafka          - Event bus (KRaft mode, no Zookeeper)
#
# Usage:
#   Multi-container: docker compose up
#   Monolith:        docker compose up store    (backwards compatible)

services:
  # --- Monolith mode (backwards compatible) ---
  store:
    build:
      context: ../..
      dockerfile: example/ecommerce-app/Dockerfile
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - JWT_SECRET=change-me-in-production-use-a-real-secret
    volumes:
      - store-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    profiles:
      - monolith

  # --- Kafka (KRaft mode â€” no Zookeeper) ---
  kafka:
    image: bitnami/kafka:3.7
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    profiles:
      - distributed

  # --- Gateway: SPA + reverse proxy ---
  gateway:
    build:
      context: ../..
      dockerfile: example/ecommerce-app/Dockerfile
    ports:
      - "8080:8080"
    command: ["./server", "-config", "config/configs/gateway.yaml"]
    depends_on:
      users-products:
        condition: service_healthy
      orders:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    profiles:
      - distributed

  # --- Users & Products service ---
  users-products:
    build:
      context: ../..
      dockerfile: example/ecommerce-app/Dockerfile
    environment:
      - JWT_SECRET=change-me-in-production-use-a-real-secret
    command: ["./server", "-config", "config/configs/users-products.yaml"]
    volumes:
      - users-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    profiles:
      - distributed

  # --- Orders service (with Kafka) ---
  orders:
    build:
      context: ../..
      dockerfile: example/ecommerce-app/Dockerfile
    environment:
      - JWT_SECRET=change-me-in-production-use-a-real-secret
    command: ["./server", "-config", "config/configs/orders.yaml"]
    volumes:
      - orders-data:/app/data
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    profiles:
      - distributed

  # --- Observability ---
  prometheus:
    image: prom/prometheus:v2.51.0
    ports:
      - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.0
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  store-data:
  users-data:
  orders-data:
